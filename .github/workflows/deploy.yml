name: Deploy to Cloudflare Pages

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  check:
    name: Check Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate JSON files
        run: |
          echo "Validating JSON files..."
          for file in data/*.json; do
            if [ -f "$file" ]; then
              echo "Checking $file"
              python3 -m json.tool "$file" > /dev/null || exit 1
            fi
          done
          echo "✅ All JSON files are valid"

      - name: Check HTML files
        run: |
          echo "Checking HTML files..."
          for file in *.html; do
            if [ -f "$file" ]; then
              echo "Checking $file"
              # Basic HTML validation - check for basic structure
              grep -q "<html" "$file" || { echo "❌ Missing <html> tag in $file"; exit 1; }
              grep -q "</html>" "$file" || { echo "❌ Missing </html> tag in $file"; exit 1; }
            fi
          done
          echo "✅ All HTML files have basic structure"

      - name: Check CSS
        run: |
          echo "Checking CSS files..."
          for file in css/*.css; do
            if [ -f "$file" ]; then
              echo "Checking $file"
              # Basic CSS validation - check for syntax errors
              grep -q "{" "$file" || { echo "❌ No CSS rules found in $file"; exit 1; }
            fi
          done
          echo "✅ CSS files look good"

      - name: Check JavaScript
        run: |
          echo "Checking JavaScript files..."
          for file in js/*.js; do
            if [ -f "$file" ]; then
              echo "Checking $file"
              node -c "$file" || exit 1
            fi
          done
          echo "✅ JavaScript files are valid"

      - name: Verify required files
        run: |
          echo "Verifying required files exist..."
          required_files=(
            "index.html"
            "about.html"
            "submit.html"
            "contact.html"
            "person.html"
            "css/style.css"
            "js/main.js"
            "data/people.json"
            "README.md"
          )
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ Required file missing: $file"
              exit 1
            fi
            echo "✅ Found: $file"
          done

  deploy:
    name: Deploy to Cloudflare Pages
    runs-on: ubuntu-latest
    needs: check
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
      deployments: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: foss-uz
          directory: .
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

  preview:
    name: Deploy Preview
    runs-on: ubuntu-latest
    needs: check
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      deployments: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy Preview to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: foss-uz
          directory: .
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
